<!DOCTYPE html>
<html>
<head>
  <title>Viewing {{ stlfile }}</title>
  <style>canvas { width: 100%; height: 100% }</style>
</head>
<body>

<script type="module">
        
  import * as THREE from "{{ url_for('serve_scripts', filename='three.module.js') }}";
  import { OrbitControls } from "{{ url_for('serve_scripts', filename='OrbitControls.js') }}";
  import { STLLoader } from "{{ url_for('serve_scripts', filename='STLLoader.js') }}";

const stl_uri = "{{ url_for('serve_file', filename=stlfile) }}"
const container = document.getElementById('viewer');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
camera.position.set(0, 0, 100);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

// Controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.rotateSpeed = 0.5;
controls.zoomSpeed = 0.5;

// Lighting
scene.add(new THREE.AmbientLight(0x888888));
const directionalLight = new THREE.DirectionalLight(0xf8f8f8, 1);
directionalLight.position.set(0, 0, 100).normalize();
scene.add(directionalLight);

// Load STL
let mesh = null; 
const loader = new STLLoader();
loader.load(stl_uri, geometry => {

    geometry.computeBoundingBox();
    const center = new THREE.Vector3();
    geometry.boundingBox.getCenter(center);
    geometry.translate(-center.x, -center.y, -center.z);

    const material = new THREE.MeshStandardMaterial({ color: 0x6699ff });
    mesh = new THREE.Mesh(geometry, material);
    mesh.rotation.x = -Math.PI / 2; // optional: align model
    scene.add(mesh);
    
    const size = new THREE.Vector3();
    geometry.boundingBox.getSize(size);
    const maxDim = Math.max(size.x, size.y, size.z);
    camera.position.set(0, 0, maxDim * 2);
});

let lastCameraQuaternion = camera.quaternion.clone();


// Render loop
function animate() {
  requestAnimationFrame(animate);
  directionalLight.position.copy(camera.position);
  renderer.render(scene, camera);
}
animate();
</script>

<div id="viewer" style="width: 800px; height: 600px;"></div>

</body>
</html>
